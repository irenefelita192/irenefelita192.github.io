variables:
  DOCKER_HOST: tcp://localhost:2375

stages:
  - build
  - push_docker

.push_docker: &push_docker
  image: google/cloud-sdk
  stage: push_docker
  services:
    - docker:18.09-dind
  script:
    - ./.gitlab/auth_gcloud.sh
    - ./.gitlab/push_bucket.sh
    - ./.gitlab/push_docker.sh
  except:
    changes:
      - qa_release_notes.md

.build: &build
  image: node:12-alpine
  stage: build
  artifacts:
    paths:
      - build/
      - node_modules/
    expire_in: 1h
  before_script:
    - echo "Building deploy package"
  script:
    - mv .npmrc.production .npmrc
    - yarn && yarn build
    - echo "Build successful"

build_staging:
  <<: *build
  only:
    - develop@apps/microsites/microsite-mola
  variables:
    ENV: staging
    NODE_ENV: staging
    REACT_APP_ENV: staging
    GCS_PATH: gs://sstv-staging-cdn/mola
    CDN_PATH: https://cdn.stag.supersoccer.tv/mola
    PUBLIC_URL: https://cdn.stag.supersoccer.tv/mola/assets/microsite

build_production:
  <<: *build
  only:
    - master@apps/microsites/microsite-mola
  variables:
    ENV: production
    NODE_ENV: production
    REACT_APP_ENV: production
    GCS_PATH: gs://koicdn-com/mola01
    CDN_PATH: https://mola01.koicdn.com
    PUBLIC_URL: https://mola01.koicdn.com/assets/microsite

push_docker_staging:
  <<: *push_docker
  before_script:
    - echo "Pushing docker image to staging..."
  variables:
    GCLOUD_SERVICE_KEY: $GCR_SSTV_KEY_STAG
    GCLOUD_PROJECT_ID: $GCR_SSTV_PROJECT_STAG
    GCS_PATH: gs://sstv-staging-cdn/mola
    CDN_PATH: https://cdn.stag.supersoccer.tv/mola
  only:
    - develop@apps/microsites/microsite-mola

push_docker_production:
  <<: *push_docker
  before_script:
    - echo "Pushing docker image to production..."
  variables:
    GCLOUD_SERVICE_KEY: $GCR_SSTV_KEY_PROD
    GCLOUD_PROJECT_ID: $GCR_SSTV_PROJECT_PROD
    GCS_PATH: gs://koicdn-com/mola01
    CDN_PATH: https://mola01.koicdn.com
  only:
    - master@apps/microsites/microsite-mola
